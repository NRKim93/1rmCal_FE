pipeline {
  agent any
  options { timestamps() }

  parameters {
    booleanParam(
      name: 'CLEAN_BUILD',
      defaultValue: true,
      description: 'Clean build (remove node_modules/.next/out)'
    )
  }

  environment {
    // GitHub
    GIT_REPO_URL       = 'https://github.com/NRKim93/1rmCal_FE.git'
    GIT_BRANCH         = 'main'
    GIT_CREDENTIALS_ID = 'github-pat-jenkins'

    // Build output
    ARTIFACT_NAME = 'deploy_bundle.tar.gz'

    // UMPC target
    UMPC_HOST     = '172.30.1.24'
    REMOTE_TMP    = 'C:/temp/the-gym-fe'   // 원격은 슬래시 권장
    UMPC_APP_DIR  = 'C:/apps/the-gym-fe'   // 원격은 슬래시 권장
    UMPC_APP_NAME = 'the-gym-fe'
    APP_PORT      = '3000'

    // Jenkins SSH credential id
    UMPC_SSH_CRED_ID = 'umpc-ssh-key'
  }

  stages {
    stage('Clean Workspace') {
      steps { cleanWs() }
    }

    stage('Checkout Source (GitHub)') {
      steps {
        echo "Checkout: ${env.GIT_REPO_URL} (${env.GIT_BRANCH})"
        checkout([
          $class: 'GitSCM',
          branches: [[name: "*/${env.GIT_BRANCH}"]],
          userRemoteConfigs: [[
            url: env.GIT_REPO_URL,
            credentialsId: env.GIT_CREDENTIALS_ID
          ]]
        ])
      }
    }

    stage('Install & Build Next.js (Windows)') {
      steps {
        script {
          def cleanFlag = params.CLEAN_BUILD ? '$true' : '$false'
          powershell """
            \$ErrorActionPreference = 'Stop'
            chcp 65001 | Out-Null
            [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

            \$cleanBuild = ${cleanFlag}
            if (\$cleanBuild) {
              Write-Host 'CLEAN_BUILD enabled: removing node_modules and build outputs'
              foreach (\$p in @('node_modules', '.next', 'out')) {
                if (Test-Path \$p) { Remove-Item -Recurse -Force \$p }
              }
            }

            node -v
            npm -v
            npm ci
            npm run build

            if (!(Test-Path '.next\\standalone')) { throw 'Missing .next\\standalone (enable output: standalone?)' }
            if (!(Test-Path '.next\\static')) { throw 'Missing .next\\static' }
          """
        }
      }
    }

    stage('Package Artifact (Windows)') {
      steps {
        powershell """
          \$ErrorActionPreference = 'Stop'
          chcp 65001 | Out-Null
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

          if (Test-Path 'deploy_bundle') { Remove-Item -Recurse -Force 'deploy_bundle' }
          New-Item -ItemType Directory -Force -Path 'deploy_bundle' | Out-Null

          Copy-Item -Recurse -Force '.next\\standalone\\*' 'deploy_bundle\\'

          New-Item -ItemType Directory -Force -Path 'deploy_bundle\\.next' | Out-Null
          Copy-Item -Recurse -Force '.next\\static' 'deploy_bundle\\.next\\static'

          if (Test-Path 'public') {
            Copy-Item -Recurse -Force 'public' 'deploy_bundle\\public'
          }

          \$ecosystem = @(
            'module.exports = {',
            '  apps: [',
            '    {',
            '      name: \"${env.UMPC_APP_NAME}\",',
            '      script: \"server.js\",',
            '      env: {',
            '        NODE_ENV: \"production\",',
            '        PORT: \"${env.APP_PORT}\"',
            '      }',
            '    }',
            '  ]',
            '}'
          ) -join \"`n\"
          \$ecosystem | Out-File -FilePath 'deploy_bundle\\ecosystem.config.cjs' -Encoding utf8 -Force

          if (Test-Path '${env.ARTIFACT_NAME}') { Remove-Item -Force '${env.ARTIFACT_NAME}' }
          tar -czf '${env.ARTIFACT_NAME}' -C deploy_bundle .

          if (!(Test-Path '${env.ARTIFACT_NAME}')) { throw 'Artifact not created' }
          Get-Item '${env.ARTIFACT_NAME}' | Format-List Name,Length,LastWriteTime
        """
      }
    }

    stage('Deploy to UMPC over SSH') {
      steps {
        withCredentials([sshUserPrivateKey(
          credentialsId: "${env.UMPC_SSH_CRED_ID}",
          keyFileVariable: 'SSH_KEY',
          usernameVariable: 'SSH_USER'
        )]) {
          powershell """
            \$ErrorActionPreference = 'Stop'
            chcp 65001 | Out-Null
            [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

            \$key      = \$env:SSH_KEY
            \$user     = \$env:SSH_USER
            \$umpcHost     = '${env.UMPC_HOST}'
            \$artifact = '${env.ARTIFACT_NAME}'

            \$remoteTmp = '${env.REMOTE_TMP}'
            \$appDir    = '${env.UMPC_APP_DIR}'
            \$appName   = '${env.UMPC_APP_NAME}'
            \$port      = '${env.APP_PORT}'

            \$dest = \"\$user@\$umpcHost\"
            \$remoteTgz = \"\$remoteTmp/\$artifact\"

            # 1) 원격 폴더 준비
            cmd /c \"ssh -i \\\"\$key\\\" -o StrictHostKeyChecking=no \\\"\$dest\\\" powershell -NoProfile -ExecutionPolicy Bypass -Command \\\"New-Item -ItemType Directory -Force -Path '\$remoteTmp' ^| Out-Null; New-Item -ItemType Directory -Force -Path '\$appDir' ^| Out-Null\\\"\"

            # 2) 아티팩트 업로드 (중요: 콜론 앞 escape)
            \$scpTarget = \"\$dest`:\$remoteTgz\"
            cmd /c \"scp -i \\\"\$key\\\" -o StrictHostKeyChecking=no \\\"\$artifact\\\" \\\"\$scpTarget\\\"\"

            # 3) 원격 실행 스크립트 (Base64 EncodedCommand)
            \$lines = @(
              '\$ErrorActionPreference = ''Stop''',
              'chcp 65001 | Out-Null',
              '[Console]::OutputEncoding = [System.Text.Encoding]::UTF8',
              \"\$tmp='${env.REMOTE_TMP}'\",
              \"\$appDir='${env.UMPC_APP_DIR}'\",
              \"\$name='${env.UMPC_APP_NAME}'\",
              \"\$port='${env.APP_PORT}'\",
              \"\$bundle=Join-Path \$tmp '${env.ARTIFACT_NAME}'\",
              'if (!(Test-Path \$bundle)) { throw (''bundle missing: '' + \$bundle) }',
              'if (Test-Path \$appDir) { \$bk=\"\$appDir.backup.\$(Get-Date -Format yyyyMMdd_HHmmss)\"; Move-Item -Force \$appDir \$bk }',
              'New-Item -ItemType Directory -Force -Path \$appDir | Out-Null',
              'tar -xzf \$bundle -C \$appDir',
              'if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) { npm i -g pm2 }',
              'Set-Location \$appDir',
              '\$env:PORT=\$port',
              'cmd /c \"pm2 delete \"\$name\" >NUL 2>&1\"',
              'if (Test-Path ''.\\\\ecosystem.config.cjs'') { pm2 start ecosystem.config.cjs } else { pm2 start server.js --name \$name }',
              'pm2 save',
              'pm2 ls --no-color'
            )

            \$remoteScript = (\$lines -join \"`n\")
            \$b64 = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes(\$remoteScript))

            cmd /c \"ssh -i \\\"\$key\\\" -o StrictHostKeyChecking=no \\\"\$dest\\\" powershell -NoProfile -ExecutionPolicy Bypass -EncodedCommand \$b64\"
          """
        }
      }
    }

    stage('Smoke Check (from Jenkins)') {
      steps {
        powershell """
          \$ErrorActionPreference = 'Continue'
          chcp 65001 | Out-Null
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

          try {
            \$url = "http://${env.UMPC_HOST}:${env.APP_PORT}/"
            Write-Host "Smoke check: \$url"
            iwr \$url -UseBasicParsing -TimeoutSec 8 | Out-Null
            Write-Host "OK"
          } catch {
            Write-Host "Smoke check failed: \$($_.Exception.Message)"
          }
        """
      }
    }

    stage('Clean Workspace (after)') {
      steps { cleanWs() }
    }
  }

  post {
    always  { echo 'Pipeline finished.' }
    success { echo '✅ Deploy succeeded.' }
    failure { echo '❌ Deploy failed.' }
  }
}
