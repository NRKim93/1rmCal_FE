pipeline {
  agent any
  options { timestamps() }

  parameters {
    booleanParam(name: 'CLEAN_BUILD', defaultValue: true, description: 'Clean build (remove node_modules/.next/out)')
  }

  environment {
    // GitHub
    GIT_REPO_URL       = 'https://github.com/NRKim93/1rmCal_FE.git'
    GIT_BRANCH         = 'main'
    GIT_CREDENTIALS_ID = 'github-pat-jenkins'

    // Build output
    ARTIFACT_NAME = 'deploy_bundle.tar.gz'

    // UMPC target
    UMPC_HOST     = '172.30.1.24'
    REMOTE_TMP    = 'C:/temp/the-gym-fe'
    UMPC_APP_DIR  = 'C:/apps/the-gym-fe'
    UMPC_APP_NAME = 'the-gym-fe'
    APP_PORT      = '3000'

    // Jenkins SSH credential id
    UMPC_SSH_CRED_ID = 'umpc-ssh-key'
  }

  stages {

    stage('Clean Workspace') {
      steps { cleanWs() }
    }

    stage('Checkout Source (GitHub)') {
      steps {
        echo "Checkout: ${env.GIT_REPO_URL} (${env.GIT_BRANCH})"
        checkout([
          $class: 'GitSCM',
          branches: [[name: "*/${env.GIT_BRANCH}"]],
          userRemoteConfigs: [[url: env.GIT_REPO_URL, credentialsId: env.GIT_CREDENTIALS_ID]]
        ])
      }
    }

    stage('Install & Build Next.js (Windows)') {
      steps {
        powershell """
          \$ErrorActionPreference = 'Stop'
          chcp 65001 | Out-Null
          [Console]::OutputEncoding = [Text.Encoding]::UTF8

          # ✅ parameter에서 안전하게 읽기 (env로 읽지 말 것)
          \$cleanBuild = [System.Convert]::ToBoolean('${params.CLEAN_BUILD}')
          if (\$cleanBuild) {
            Write-Host 'CLEAN_BUILD enabled'
            foreach (\$p in @('node_modules', '.next', 'out')) {
              if (Test-Path \$p) { Remove-Item -Recurse -Force \$p }
            }
          }

          node -v
          npm -v
          npm ci
          npm run build

          if (!(Test-Path '.next\\standalone')) { throw 'Missing .next\\standalone (set output: standalone)' }
          if (!(Test-Path '.next\\static'))     { throw 'Missing .next\\static' }
        """
      }
    }

    stage('Package Artifact (Windows)') {
      steps {
        powershell """
          \$ErrorActionPreference = 'Stop'
          chcp 65001 | Out-Null
          [Console]::OutputEncoding = [Text.Encoding]::UTF8

          Remove-Item -Recurse -Force 'deploy_bundle' -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path 'deploy_bundle' | Out-Null

          # standalone server files
          Copy-Item -Recurse -Force '.next\\standalone\\*' 'deploy_bundle\\'

          # static resources
          New-Item -ItemType Directory -Force -Path 'deploy_bundle\\.next\\static' | Out-Null
          Copy-Item -Recurse -Force '.next\\static\\*' 'deploy_bundle\\.next\\static\\'

          # public
          if (Test-Path 'public') {
            New-Item -ItemType Directory -Force -Path 'deploy_bundle\\public' | Out-Null
            Copy-Item -Recurse -Force 'public\\*' 'deploy_bundle\\public\\'
          }

          # ecosystem file
          \$ecosystem = @"
module.exports = {
  apps: [{
    name: '${env.UMPC_APP_NAME}',
    script: 'server.js',
    env: {
      NODE_ENV: 'production',
      PORT: '${env.APP_PORT}'
    }
  }]
}
"@
          \$ecosystem | Out-File -FilePath 'deploy_bundle\\ecosystem.config.cjs' -Encoding utf8 -Force

          # pack
          Remove-Item -Force '${env.ARTIFACT_NAME}' -ErrorAction SilentlyContinue
          tar -czf '${env.ARTIFACT_NAME}' -C deploy_bundle .

          if (!(Test-Path '${env.ARTIFACT_NAME}')) { throw 'Artifact not created' }
          Get-Item '${env.ARTIFACT_NAME}' | Format-List Name,Length,LastWriteTime
        """
      }
    }

    stage('Deploy to UMPC over SSH') {
      steps {
        withCredentials([sshUserPrivateKey(
          credentialsId: "${env.UMPC_SSH_CRED_ID}",
          keyFileVariable: 'SSH_KEY',
          usernameVariable: 'SSH_USER'
        )]) {
          powershell '''
            $ErrorActionPreference = 'Stop'
            chcp 65001 | Out-Null
            [Console]::OutputEncoding = [Text.Encoding]::UTF8

            # 디버그: env 값 확인
            Write-Host ("ENV_UMPC_HOST_RAW=[" + $env:UMPC_HOST + "]")

            # --- raw values (문자열 강제) ---
            $keyRaw  = [string]$env:SSH_KEY
            $userRaw = [string]$env:SSH_USER
            $hostRaw = [string]$env:UMPC_HOST

            # --- sanitize (PS 5.1 호환) ---
            $key       = ('' + $keyRaw ).Trim().Trim('[',']','"')
            $user      = ('' + $userRaw).Trim().Trim('[',']','"')
            $umpcHost  = ('' + $hostRaw).Trim().Trim('[',']','"')   # ✅ $Host 예약어 절대 안 씀

            if ([string]::IsNullOrWhiteSpace($user))     { throw "SSH_USER is empty" }
            if ([string]::IsNullOrWhiteSpace($umpcHost)) { throw "UMPC_HOST is empty" }
            if ([string]::IsNullOrWhiteSpace($key))      { throw "SSH_KEY is empty" }

            if (!(Test-Path $key)) {
              throw "SSH key file not found: [$key]"
            }

            $remoteTmp = [string]$env:REMOTE_TMP
            $appDir    = [string]$env:UMPC_APP_DIR
            $appName   = [string]$env:UMPC_APP_NAME
            $port      = [string]$env:APP_PORT
            $artifact  = [string]$env:ARTIFACT_NAME

            $dest = ("{0}@{1}" -f $user, $umpcHost).Trim()
            $remoteTgz = "$remoteTmp/$artifact"

            Write-Host "SSH_USER=[$user]"
            Write-Host "UMPC_HOST=[$umpcHost]"
            Write-Host "DEST=[$dest]"
            Write-Host "SSH_KEY=[****]"

            function Run-External([string]$exe, [object[]]$args) {
              # exe 존재 확인 (PATH 문제면 여기서 바로 잡힘)
              $cmd = Get-Command $exe -ErrorAction SilentlyContinue
              if (-not $cmd) {
                throw "Executable not found in PATH: [$exe]  (try full path like C:\\Windows\\System32\\OpenSSH\\ssh.exe)"
              }

              # 로그 출력(PS5.1 안전)
              $printed = ""
              foreach ($a in $args) { $printed += "[$a] " }
              Write-Host ("RUN: {0} {1}" -f $exe, $printed.Trim())

              # 실행 + stderr/stdout 합치기
              $output = & $exe @args 2>&1

              # ★ 중요: 출력 찍기 전에 exit code를 먼저 저장
              $exit = $LASTEXITCODE

              foreach ($line in $output) { Write-Host $line }

              if ($exit -ne 0) {
                throw "Command failed ($exit): $exe"
              }
            }

            # ssh 버전 출력(참고용)
            try { & ssh -V 2>&1 | ForEach-Object { Write-Host $_ } } catch { }

            # 1) 원격 디렉토리 생성
            $mk = @"
`$ErrorActionPreference = 'Stop'
New-Item -ItemType Directory -Force -Path '$remoteTmp' | Out-Null
New-Item -ItemType Directory -Force -Path '$appDir'    | Out-Null
"@
            $mkB64 = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($mk))

            Run-External 'ssh' @(
              '-i', $key,
              '-o', 'StrictHostKeyChecking=no',
              $dest,
              'powershell', '-NoProfile', '-ExecutionPolicy', 'Bypass',
              '-EncodedCommand', $mkB64
            )

            # 2) 아티팩트 업로드
            Run-External 'scp' @(
              '-i', $key,
              '-o', 'StrictHostKeyChecking=no',
              $artifact,
              "${dest}:$remoteTgz"
            )

            # 3) 원격 배포
            $deploy = @"
`$ErrorActionPreference = 'Stop'
chcp 65001 | Out-Null
[Console]::OutputEncoding = [Text.Encoding]::UTF8

`$tmp    = '$remoteTmp'
`$app    = '$appDir'
`$name   = '$appName'
`$port   = '$port'
`$bundle = Join-Path `$tmp '$artifact'

if (!(Test-Path `$bundle)) { throw ('bundle missing: ' + `$bundle) }

if (Test-Path `$app) {
  `$bk = `$app + '.backup.' + (Get-Date -Format yyyyMMdd_HHmmss)
  Move-Item -Force `$app `$bk
}

New-Item -ItemType Directory -Force -Path `$app | Out-Null
tar -xzf `$bundle -C `$app

if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) { npm i -g pm2 }

Set-Location `$app
`$env:PORT = `$port

try { pm2 delete `$name 2>`$null | Out-Null } catch { }

if (Test-Path '.\\ecosystem.config.cjs') {
  pm2 start ecosystem.config.cjs
} else {
  pm2 start server.js --name `$name
}

pm2 save
pm2 ls --no-color
"@
            $deployB64 = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($deploy))

            Run-External 'ssh' @(
              '-i', $key,
              '-o', 'StrictHostKeyChecking=no',
              $dest,
              'powershell', '-NoProfile', '-ExecutionPolicy', 'Bypass',
              '-EncodedCommand', $deployB64
            )
          '''
        }
      }
    }

    stage('Smoke Check') {
      steps {
        powershell """
          \$ErrorActionPreference = 'Continue'
          chcp 65001 | Out-Null
          [Console]::OutputEncoding = [Text.Encoding]::UTF8

          try {
            \$url = 'http://${env.UMPC_HOST}:${env.APP_PORT}/'
            Write-Host "Smoke check: \$url"
            Invoke-WebRequest \$url -UseBasicParsing -TimeoutSec 10 | Out-Null
            Write-Host 'Smoke check OK'
          } catch {
            Write-Host "Smoke check failed: \$($_.Exception.Message)"
          }
        """
      }
    }

    stage('Clean Workspace (after)') {
      steps { cleanWs() }
    }
  }

  post {
    always  { echo 'Pipeline finished.' }
    success { echo '✅ Deploy succeeded.' }
    failure { echo '❌ Deploy failed.' }
  }
}
