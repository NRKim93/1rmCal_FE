stage('Deploy to UMPC over SSH') {
  steps {
    withCredentials([sshUserPrivateKey(
      credentialsId: "${env.UMPC_SSH_CRED_ID}",
      keyFileVariable: 'SSH_KEY',
      usernameVariable: 'SSH_USER'
    )]) {
      powershell """
        \$ErrorActionPreference = 'Stop'
        chcp 65001 | Out-Null
        [Console]::OutputEncoding = [Text.Encoding]::UTF8

        \$key  = \$env:SSH_KEY
        \$user = \$env:SSH_USER

        # ✅ PowerShell 예약변수 \$Host 피하기
        \$umpcHost  = '${env.UMPC_HOST}'
        \$remoteTmp = '${env.REMOTE_TMP}'
        \$appDir    = '${env.UMPC_APP_DIR}'
        \$appName   = '${env.UMPC_APP_NAME}'
        \$port      = '${env.APP_PORT}'
        \$artifact  = '${env.ARTIFACT_NAME}'

        \$dest = \"\$user@\$umpcHost\"
        \$remoteTgz = \"\$remoteTmp/\$artifact\"

        function Run-External([string]\$exe, [object[]]\$args) {
          \$out = & \$exe @args 2>&1
          \$out | ForEach-Object { Write-Host \$_ }
          if (\$LASTEXITCODE -ne 0) {
            throw \"Command failed (\$LASTEXITCODE): \$exe \$([string]::Join(' ', \$args))\"
          }
        }

        # 1) 원격 디렉토리 생성 (EncodedCommand로 따옴표/파이프 지옥 제거)
        \$mk = @\"
\$ErrorActionPreference = 'Stop'
New-Item -ItemType Directory -Force -Path '\$remoteTmp' | Out-Null
New-Item -ItemType Directory -Force -Path '\$appDir'    | Out-Null
\"\@
        \$mkB64 = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes(\$mk))

        Run-External 'ssh' @(
          '-i', \$key,
          '-o', 'StrictHostKeyChecking=no',
          \$dest,
          'powershell', '-NoProfile', '-ExecutionPolicy', 'Bypass',
          '-EncodedCommand', \$mkB64
        )

        # 2) 아티팩트 업로드
        Run-External 'scp' @(
          '-i', \$key,
          '-o', 'StrictHostKeyChecking=no',
          \$artifact,
          \"\${dest}:\$remoteTgz\"
        )

        # 3) 원격 배포 (EncodedCommand)
        \$deploy = @\"
\$ErrorActionPreference = 'Stop'
chcp 65001 | Out-Null
[Console]::OutputEncoding = [Text.Encoding]::UTF8

\$tmp    = '$remoteTmp'
\$app    = '$appDir'
\$name   = '$appName'
\$port   = '$port'
\$bundle = Join-Path \$tmp '$artifact'

if (!(Test-Path \$bundle)) { throw ('bundle missing: ' + \$bundle) }

if (Test-Path \$app) {
  \$bk = \$app + '.backup.' + (Get-Date -Format yyyyMMdd_HHmmss)
  Move-Item -Force \$app \$bk
}

New-Item -ItemType Directory -Force -Path \$app | Out-Null
tar -xzf \$bundle -C \$app

if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) { npm i -g pm2 }

Set-Location \$app
\$env:PORT = \$port

# pm2 delete는 없어도 괜찮게 처리
try { pm2 delete \$name 2>\$null | Out-Null } catch { }

if (Test-Path '.\\\\ecosystem.config.cjs') {
  pm2 start ecosystem.config.cjs
} else {
  pm2 start server.js --name \$name
}

pm2 save
pm2 ls --no-color
\"\@

        \$deployB64 = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes(\$deploy))

        Run-External 'ssh' @(
          '-i', \$key,
          '-o', 'StrictHostKeyChecking=no',
          \$dest,
          'powershell', '-NoProfile', '-ExecutionPolicy', 'Bypass',
          '-EncodedCommand', \$deployB64
        )
      """
    }
  }
}
