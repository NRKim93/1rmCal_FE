pipeline {
  agent any
  options { timestamps() }

  parameters {
    booleanParam(
      name: 'CLEAN_BUILD',
      defaultValue: true,
      description: 'Clean build (remove node_modules/.next/out)'
    )
  }

  environment {
    // GitHub
    GIT_REPO_URL       = 'https://github.com/NRKim93/1rmCal_FE.git'
    GIT_BRANCH         = 'main'
    GIT_CREDENTIALS_ID = 'github-pat-jenkins'

    // Build output
    ARTIFACT_NAME = 'deploy_bundle.tar.gz'

    // UMPC target (원격 경로는 / 권장)
    UMPC_HOST     = '172.30.1.24'
    REMOTE_TMP    = 'C:/temp/the-gym-fe'
    UMPC_APP_DIR  = 'C:/apps/the-gym-fe'
    UMPC_APP_NAME = 'the-gym-fe'
    APP_PORT      = '3000'

    // Jenkins SSH credential id
    UMPC_SSH_CRED_ID = 'umpc-ssh-key'
  }

  stages {

    stage('Clean Workspace') {
      steps { cleanWs() }
    }

    stage('Checkout Source (GitHub)') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: "*/${env.GIT_BRANCH}"]],
          userRemoteConfigs: [[
            url: env.GIT_REPO_URL,
            credentialsId: env.GIT_CREDENTIALS_ID
          ]]
        ])
      }
    }

    stage('Install & Build Next.js (Windows)') {
      steps {
        powershell """
          \$ErrorActionPreference = 'Stop'
          chcp 65001 | Out-Null
          [Console]::OutputEncoding = [Text.Encoding]::UTF8

          if (${params.CLEAN_BUILD} -eq \$true) {
            Write-Host 'CLEAN_BUILD enabled'
            foreach (\$p in @('node_modules','.next','out')) {
              if (Test-Path \$p) { Remove-Item -Recurse -Force \$p }
            }
          }

          node -v
          npm -v
          npm ci
          npm run build

          if (!(Test-Path '.next\\standalone')) { throw 'Missing .next\\standalone (set output: standalone)' }
          if (!(Test-Path '.next\\static'))     { throw 'Missing .next\\static' }
        """
      }
    }

    stage('Package Artifact') {
      steps {
        powershell """
          \$ErrorActionPreference = 'Stop'
          chcp 65001 | Out-Null
          [Console]::OutputEncoding = [Text.Encoding]::UTF8

          # clean
          Remove-Item -Recurse -Force 'deploy_bundle' -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path 'deploy_bundle' | Out-Null

          # standalone server files
          Copy-Item -Recurse -Force '.next\\standalone\\*' 'deploy_bundle\\'

          # static resources
          New-Item -ItemType Directory -Force -Path 'deploy_bundle\\.next\\static' | Out-Null
          Copy-Item -Recurse -Force '.next\\static\\*' 'deploy_bundle\\.next\\static\\'

          # public
          if (Test-Path 'public') {
            Copy-Item -Recurse -Force 'public\\*' 'deploy_bundle\\public\\'
          }

          # ecosystem file (단순 문자열로 작성)
          \$ecosystem = @"
module.exports = {
  apps: [{
    name: '${env.UMPC_APP_NAME}',
    script: 'server.js',
    env: {
      NODE_ENV: 'production',
      PORT: '${env.APP_PORT}'
    }
  }]
}
"@
          \$ecosystem | Out-File -FilePath 'deploy_bundle\\ecosystem.config.cjs' -Encoding utf8 -Force

          # pack
          Remove-Item -Force '${env.ARTIFACT_NAME}' -ErrorAction SilentlyContinue
          tar -czf '${env.ARTIFACT_NAME}' -C deploy_bundle .

          if (!(Test-Path '${env.ARTIFACT_NAME}')) { throw 'Artifact not created' }
          Get-Item '${env.ARTIFACT_NAME}' | Format-List Name,Length,LastWriteTime
        """
      }
    }

    stage('Deploy to UMPC over SSH') {
      steps {
        withCredentials([sshUserPrivateKey(
          credentialsId: "${env.UMPC_SSH_CRED_ID}",
          keyFileVariable: 'SSH_KEY',
          usernameVariable: 'SSH_USER'
        )]) {
          powershell """
            \$ErrorActionPreference = 'Stop'
            chcp 65001 | Out-Null
            [Console]::OutputEncoding = [Text.Encoding]::UTF8

            \$key  = \$env:SSH_KEY
            \$dest = \"\$env:SSH_USER@${env.UMPC_HOST}\"

            # 1) 원격 디렉토리 생성
            ssh -i \$key -o StrictHostKeyChecking=no \$dest `
              \"powershell -NoProfile -ExecutionPolicy Bypass -Command \\\"New-Item -ItemType Directory -Force -Path '${env.REMOTE_TMP}','${env.UMPC_APP_DIR}' | Out-Null\\\"\"

            # 2) 아티팩트 전송 (콜론 파서 문제 회피)
            \$remoteTgz = '${env.REMOTE_TMP}/${env.ARTIFACT_NAME}'
            scp -i \$key -o StrictHostKeyChecking=no '${env.ARTIFACT_NAME}' \"\${dest}:\$remoteTgz\"

            # 3) 원격 배포 스크립트 (EncodedCommand)
            \$remote = @(
              ' \$ErrorActionPreference = ''Stop'' ',
              ' chcp 65001 | Out-Null ',
              ' [Console]::OutputEncoding = [Text.Encoding]::UTF8 ',
              ' \$tmp = ''${env.REMOTE_TMP}'' ',
              ' \$app = ''${env.UMPC_APP_DIR}'' ',
              ' \$name = ''${env.UMPC_APP_NAME}'' ',
              ' \$port = ''${env.APP_PORT}'' ',
              ' \$bundle = Join-Path \$tmp ''${env.ARTIFACT_NAME}'' ',
              ' if (!(Test-Path \$bundle)) { throw (''bundle missing: '' + \$bundle) } ',
              ' if (Test-Path \$app) { \$bk = \"\$app.backup.\$(Get-Date -Format yyyyMMdd_HHmmss)\"; Move-Item -Force \$app \$bk } ',
              ' New-Item -ItemType Directory -Force -Path \$app | Out-Null ',
              ' tar -xzf \$bundle -C \$app ',
              ' if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) { npm i -g pm2 } ',
              ' Set-Location \$app ',
              ' \$env:PORT = \$port ',
              ' cmd /c \"pm2 delete \\\"\$name\\\" >NUL 2>&1\" ',
              ' if (Test-Path \".\\\\ecosystem.config.cjs\") { pm2 start ecosystem.config.cjs } else { pm2 start server.js --name \$name } ',
              ' pm2 save ',
              ' pm2 ls --no-color '
            ) -join \"`n\"

            \$b64 = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes(\$remote))
            ssh -i \$key -o StrictHostKeyChecking=no \$dest `
              \"powershell -NoProfile -ExecutionPolicy Bypass -EncodedCommand \$b64\"
          """
        }
      }
    }

    stage('Smoke Check') {
      steps {
        powershell """
          \$ErrorActionPreference = 'Continue'
          try {
            Invoke-WebRequest 'http://${env.UMPC_HOST}:${env.APP_PORT}/' -TimeoutSec 8 | Out-Null
            Write-Host 'Smoke check OK'
          } catch {
            Write-Host 'Smoke check failed'
          }
        """
      }
    }

    stage('Clean Workspace (after)') {
      steps { cleanWs() }
    }
  }

  post {
    success { echo '✅ Deploy succeeded.' }
    failure { echo '❌ Deploy failed.' }
    always  { echo 'Pipeline finished.' }
  }
}
